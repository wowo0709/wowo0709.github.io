---
layout: single
title: "[TFLite] 9(2). 학습 후 양자화"
---

<br>

# 학습 후 양자화

<br>

### 개요

---

학습 후 양자화는 학습된 모델을 TFLite 모델로 변환할 때 적용합니다. 모델이 학습할 때에는 그대로 32비트 부동 소수점을 사용하고, 학습이 끝난 뒤 이를 16비트 부동 소수점이나 8비트 고정 소수점까지 줄임으로써 모델의 크기와 추론 소요 시간을 단축하는 방식입니다. 

학습 후 양자화를 수행하면 모델의 정확도가 다소 떨어질 수 밖에 없기 때문에 학습 후에 정확도가 얼마나 손실되었는지 확인해야 합니다. 

학습 후 양자화의 유형에는 **Dynamic 양자화**, **Integer 양자화**, **Float16 양자화**가 있습니다. 

<br>

[학습 후 양자화의 유형]

| 유형          | 정밀도      | 양자화 대상                      | 특징                                   |
| ------------- | ----------- | -------------------------------- | -------------------------------------- |
| Dynamic Range | 8비트(1/4)  | 가중치                           | 활성화를 동적으로 양자화               |
| Integer       | 8비트(1/4)  | 가중치+레이어 입출력             | 대표 데이터셋 필요                     |
|               |             | 가중치+레이어 입출력+모델 입출력 | 대표 데이터셋 필요, Int 전용 기기 호환 |
| Float16       | 16비트(1/2) | 가중치                           | GPU 호환성                             |

<br>

[학습 후 양자화의 유형 선택을 위한 의사결정 트리]

<img src="C:\Users\wjsdu\AppData\Roaming\Typora\typora-user-images\image-20210824220149596.png" alt="image-20210824220149596" style="zoom: 67%;" />

<br>

학습 후 양자화의 유형 별로 각 양자화를 적용한 모델을 생성하여 1. 각각의 모델 크기, 2. 정확도, 3. 추론 소요 시간을 비교해보겠습니다. 

모델 크기는 모델을 변환하면서 바로 비교하고, 정확도는 모델을 모두 변환한 뒤 확인하며, 추론 소요 시간은 모델을 안드로이드 기기에 배포한 뒤 앱에서 측정할 것입니다. 

<br>

<br>

### 양자화 모델의 크기 비교

---

먼저 양자화를 적용하지 않은 MobileNetV2 모델을 tflite 파일로 변환한 뒤 양자화를 적용한 모델과 비교해봅니다. 

<br>

**양자화 없이 tflite 파일로 변환**

```python
def save_model_tflite(model, path):
    converter = tf.lite.TFLiteConverter.from_keras_model(model)
    tflite_model = converter.convert()
    with open(path, 'wb') as f:
        f.write(tflite_model)
        
    return os.path.getsize(path)
```

이 함수를 이용하여 MoblieNetV2 모델을 다음과 같이 변환합니다. 

<br>

**MoblieNetV2 모델을 tflite 파일로 변환한 후 용량 확인**

```python
mobilenet_model = tf.keras.applications.MobileNetV2(weights="imagenet")
origin_size = save_model_tflite(mobilenet_model, "mobilenet.tflite")
print(f'origin_size : {origin_size}')

out:
  origin_size : 13989548
```

양자화를 적용하지 않은 MobileNetV2의 크기는 약 13메가바이트입니다. 이제 각 양자화 기법을 적용한 모델을 생성하면서 양자화를 적용하지 않은 모델과 비교해봅시다. 

<br>

#### Dynamic Range 양자화

